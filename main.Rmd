---
title: "main"
author: "Dmitry Zotikov"
date: "March 26, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## TODO:

- E, D of norm
- MC ACF
- Fit MC
- Find MC stationary distribution
- stationary mc distribution -- when important? one extra multiplication is
  not a big deal...
- NULL => stationary
- hmm pdf in the case of a stationary MC
- HMM for m = 1 (make sure it's working)
- sd or sd^2?
- hist of gen.sample -- unimodal??
- test on model solution
- compare pois hmm component densities with zuc
- proper initialize, missing(), ...
- optim, constrOptim
- forecast for continuous
- while fitting, check the code; if not 1, act appropriately

- Почитать Hasan и другие статьи по hmm+forecast
- Понять, почему важно иметь предсказание распределения (для геологов) и т.д.
- Задачи, где СММ выбирают модель
- Максимум hist и curve / pdf в графиках

 - fix plotForecast --- xlim via x.probes

 - prediction on smoothed ts?
 - is hmm necessary? if acf != 0, just work with differences
 
 - Кросс-валидация vs AIC/BIC
 - Документ по IC
 - Доверительный интервал через профили
 - Документ по прогнозу: Hong; Hassan
 - $\max_{x}\P(\xi_{T+h}=x\mid\mathbf{x})$
 - Протестировать на модельном решении (нагенерить ряд как смесь тренда, периодики, шума)
 - Ансамбль моделей
 - The state-dependent density functions can also be estimated nonparametrically, hence avoiding the need to make any distributional assumption (Langrock et al., 2015)

## EQ-Pois forward forecasting

```{r, eval=FALSE, message=FALSE, include=FALSE}
source('import_earthquakes.R')
source('util_plot.R')
source('pois_hmm.R')

xx <- earthquakes.zuc.annual$count
x.probes <- 0:50
h.max <- 16

hmm <- PoisHmm(4, xx)
hmm$fit(xx)
# plotForecastDist(hmm$forecastDist(xx, x.probes, h.max), xx, x.probes)
fc <- hmm$forecast(xx, x.probes, h.max, 'median')
plotForecast(fc, xx, h.max)
```

## EQ-Pois train/test forecasting

```{r, fig.height=10, fig.width=9, message=FALSE, include=FALSE}
source('import_earthquakes.R')
source('util_plot.R')
source('pois_hmm.R')

xx <- earthquakes.zuc.annual$count
x.probes <- 0:50
h.max <- 16

T <- length(xx)
T.train <- T-h.max
xx.train <- xx[1:(T.train)]
xx.true <- xx[(T.train+1):T]
hmm <- PoisHmm(4, xx.train)
hmm$fit(xx.train)
plotForecastDist(hmm$forecastDist(xx.train, x.probes, h.max), xx.train, x.probes)
par(mfrow=c(3,1))
for (avg in c('mean', 'median', 'mode')) {
  fc <- hmm$forecast(xx.train, x.probes, h.max, avg)
  plotForecast(fc, xx.train, h.max, xx.true)
  title(avg)
}
par(mfrow=c(1,1))
```

## Sine model forward forecasting

```{r}
source('util_plot.R')
source('norm_hmm.R')
source('modsel.R')
library('forecast')

set.seed(2)
T <- 100
tt <- seq(0, 4*pi, length.out=T)
# par(mfrow=c(3, 1))
xx <- 1 + 0.5*tt
# plot(xx, type='l')
xx <- xx + sin(2*tt)
# plot(xx, type='l')
xx <- xx + runif(100, -2, 2)
xx <- ts(xx)
# plot(xx, type='o')
# par(mfrow=c(1,1))
# acf(xx, T)

h.max <- 16

x.probes <- seq(min(xx), max(xx), length.out = 50)
# selectModelIc(NormHmm, xx, 7, TRUE)  # 2
hmm <- NormHmm(2, xx)
hmm$fit(xx)
plotA(hmm)
```

```{r, fig.height=10, fig.width=9}
plotForecastDist(hmm$forecastDist(xx, x.probes, h.max), xx, x.probes)
par(mfrow=c(3,1))
for (avg in c('mean', 'median', 'mode')) {
  fc <- hmm$forecast(xx, x.probes, h.max, avg)
  plotForecast(fc, xx, h.max)
  title(avg)
}
par(mfrow=c(1,1))
```

```{r}
# auto.arima(xx)
plot(forecast(arima(xx, order=c(0, 1, 1)), h.max))
```

## Sine model with train/test forecasting

```{r}
source('util_plot.R')
source('norm_hmm.R')
source('modsel.R')
library('forecast')

set.seed(2)
T <- 100
tt <- seq(0, 4*pi, length.out=T)
xx <- ts(1 + 0.5*tt + sin(2*tt) + runif(100, -2, 2))

h.max <- 16
T.train <- T-h.max
xx.train <- xx[1:(T.train)]
xx.true <- xx[(T.train+1):T]

x.probes <- seq(min(xx.train), max(xx.train), length.out = 50)
# selectModelIc(NormHmm, xx.train, 7, TRUE)  # 4, 2
hmm <- NormHmm(2, xx.train)
hmm$fit(xx.train)
plotA(hmm)
```

```{r, fig.height=10, fig.width=9, message=FALSE}
plotForecastDist(hmm$forecastDist(xx.train, x.probes, h.max), xx.train, x.probes)
par(mfrow=c(3,1))
for (avg in c('mean', 'median', 'mode')) {
  fc <- hmm$forecast(xx.train, x.probes, h.max, avg)
  plotForecast(fc, xx.train, h.max, xx.true)
  title(avg)
}
par(mfrow=c(1,1))
```

```{r}
# auto.arima(xx)
plot(forecast(arima(xx, order=c(0, 1, 1)), h.max))
```

### $m=4$

```{r}
hmm <- NormHmm(4, xx.train)
hmm$fit(xx.train)
plotA(hmm)
```

```{r, fig.height=10, fig.width=9, message=FALSE}
plotForecastDist(hmm$forecastDist(xx.train, x.probes, h.max), xx.train, x.probes)
par(mfrow=c(3,1))
for (avg in c('mean', 'median', 'mode')) {
  fc <- hmm$forecast(xx.train, x.probes, h.max, avg)
  plotForecast(fc, xx.train, h.max, xx.true)
  title(avg)
}
par(mfrow=c(1,1))
```

```{r}
# auto.arima(xx)
plot(forecast(arima(xx, order=c(0, 1, 1)), h.max))
```
