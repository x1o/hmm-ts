---
title: "Consistency 2"
author: "Dmitry Zotikov"
date: "April 7, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
plot.data.summary <- function(xx) {
  par(mfrow=c(2,2))
  plot(xx, type='o', pch=20)
  hist(xx)
  acf(xx, length(xx))
  par(mfrow=c(1,1))
}
```

```{r}
source('pois_hmm.R')
```

```{r}
init.ref.pois.model <- function(m, do.plot=FALSE) {
  lambda <- m
  A <- matrix(rpois(m^2, lambda), m, m)
  A <- A / rowSums(A)
  if (do.plot) {
    cat('min / max A:', min(A), ' / ', max(A), '\n')
    min(A); max(A)
    image(A, zlim=c(0, max(A)), col=terrain.colors(m^2))
  }
  priors <- rpois(m, lambda)
  priors <- priors / sum(priors)
  lambda <- ceiling(runif(m, 1, 10))
  PoisHmm(A=A, priors=priors, pdf.params=list(lambda=lambda))
}
```

```{r}
set.seed(1)
m <- 10
T <- 100
hmm.ref <- init.ref.pois.model(m)
xx <- hmm.ref$genSample(T)
plot.data.summary(xx)
```

```{r}
set.seed(1)
m.max <- 25
res <- matrix(0, m.max, 4)
colnames(res) <- c('mllk.ref', 'mllk', 'mllk.ref/mllk', 'n.iter')
mm <- seq(2, m.max)
cat(colnames(res), '\n')
for (k in 1:length(mm)) {
  cat('m = ', mm[k], '... ')
  hmm.ref <- init.ref.pois.model(mm[k])
  xx <- hmm.ref$genSample(100)
  mllk.ref <- -hmm.ref$logL(xx)
  res[k, 1] <- mllk.ref
  hmm <- PoisHmm(mm[k], xx)
  hmm$fit(xx)
  res[k, 2] <- -hmm$logL(xx)
  res[k, 3] <- res[k, 1] / res[k, 2]
  res[k, 4] <- hmm$n.iter
  cat(res[k,], '\n')
}
```

Проблема в get / set working parameters: `log(exp(-999)) = 0 != -999`

